<%
  config = field.associated_model_config
  selected = field.selected(params)
  xhr = field.associated_collection_count > 100

  if xhr
    collection = [[field.formatted_value, selected]]
  else
    collection = field.associated_collection
  end
%>

<%= debug field.method_name %>
              <div class="field <%= "#{field.dom_id}" %>">
                <%= form.label field.method_name, field.label %>
                <%= select_tag field.method_name, collection, {:include_blank => true, :selected => selected}, field.html_attributes %>
                <% if authorized? :new, @abstract_model %>
                  <%= link_to "Add new #{config.abstract_model.to_param}", rails_admin_new_path(:model_name => config.abstract_model.to_param ), :class => "createAssociatedRecord" %>
                <% end %>
                <% if field.has_errors? %>
                <span class="errorMessage"><%= "#{field.label } #{field.errors.first}" %></span>
                <% end %>
                <p class="help"><%= field.help %></p>
                <% head_style 'rails_admin/ra.filtering-select.css' %>
                <% head_javascript "rails_admin/ra.filtering-select.js" %>
                <% head_javascript do %>
                  $j(document).ready(function($){
                    $(".<%= "#{field.dom_id}" %> .createAssociatedRecord").remoteForm({ dialogClass: "createAssociatedRecordDialog" });
                    $("#<%= "#{field.dom_id}" %>").filteringSelect({
                      <% if xhr %>
                        createQuery: function(query) {
                          return { filter: { '<%= field.associated_label_method %>': query + '%' }Â }
                        },
                        source: "<%= rails_admin_list_path(config.abstract_model.to_param, :compact => true) %>"
                      <% end %>
                    });
                  });
                <% end %>
              </div>