<%
  config = field.associated_model_config
  selected = field.selected(params)
  xhr = field.associated_collection_count > 100

  if xhr
    collection = config.abstract_model.get_bulk(selected).map do |o|
      [config.with(:object => o).object_label, o.id]
    end
  else
    collection = field.associated_collection
  end
  
  # put selected objects first, in the right order.
  collection = collection.sort_by {|a| selected.index(a[1]) || selected.size } if field.orderable


%>


              <div class="field <%= "#{field.dom_id}" %>">
                <%= form.label field.method_name, field.label %>
                <input type="hidden" name="<%= field.dom_name %>" value=""/>
                <%= form.select field.method_name, collection, { :selected => selected }, field.html_attributes %>
                <% if field.has_errors? %>
                <span class="errorMessage"><%= "#{field.label} #{field.errors.first}" %></span>
                <% end %>
                <p class="help"><%= field.help %></p>
                <% head_style 'rails_admin/ra.filtering-multiselect.css' %>
                <% head_javascript "rails_admin/ra.filtering-multiselect.js" %>
                <% head_javascript do %>
                  $j(document).ready(function($){
                    $("#<%= "#{field.dom_id}" %>").filteringMultiselect({
                      <% if xhr %>
                        createQuery: function(query) {
                          return { filter: { '<%= field.associated_label_method %>': query + '%' }Â }
                        },
                        source: "<%= rails_admin_list_path(config.abstract_model.to_param, :compact => true) %>",
                      <% end %>
                        sortable: <%= field.orderable ? 'true' : 'false' %>,
                      regional: {
                        chooseAll: "<%= t("admin.new.chose_all") %>",
                        chosen: "<%= t("admin.new.chosen", :name => config.abstract_model.model.model_name.human(:count => 2, :default => config.label.pluralize)) %>",
                        clearAll:  "<%= t("admin.new.clear_all") %>",
                        selectChoice: "<%= t("admin.new.select_choice") %>",
                        up: "<%= t("admin.new.up") %>",
                        down: "<%= t("admin.new.down") %>"
                      }
                    });
                  });
                <% end %>
              </div>
